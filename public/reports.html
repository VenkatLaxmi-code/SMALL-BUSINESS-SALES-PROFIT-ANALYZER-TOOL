<!DOCTYPE html>
<html>

<head>
    <title>AI Business Report</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="box" style="width:95%;max-width:900px;">

        <!-- ðŸ”¹ TOP SUMMARY (UNCHANGED LOGIC) -->
        <h2>ðŸ¤– AI Business Insights</h2>
        <p id="summary"></p>

        <hr><br>

        <!-- ðŸ”¹ PRODUCT SEARCH -->
        <h3>ðŸ“¦ Product-wise Sales Prediction</h3>
        <input id="productSearch" placeholder="Enter product name (e.g., Ball Pen)">
        <button onclick="analyzeProduct()">Analyze</button>

        <br><br>

        <!-- ðŸ”¹ GRAPH -->
        <canvas id="productChart" height="120"></canvas>

        <!-- ðŸ”¹ AI MESSAGE -->
        <!-- ðŸ”¹ AI MESSAGE -->
        <h3 id="decision" style="text-align:center;margin-top:15px;"></h3>

        <hr>

        <!-- ðŸ”¹ REPORT ACTION BUTTONS -->
        <div style="text-align:center; margin-top:15px;">
            <button onclick="downloadPDF()">ðŸ“„ Download PDF</button>
            <button onclick="downloadExcel()">ðŸ“Š Download Excel</button>
            <button onclick="emailReport()">ðŸ“§ Email Report</button>

        </div>

        <br>
        <button onclick="location.href='dashboard.html'">Back</button>

    </div>

    <script>
        const token = localStorage.getItem("token");
        let allSales = [];
        let chart;

        /* ðŸ”¹ LOAD OVERALL AI SUMMARY */
        fetch("http://localhost:5000/ai-report", {
            headers: { Authorization: token }
        })
            .then(r => r.json())
            .then(d => {
                summary.innerHTML = `
          <b>Total Sales:</b> â‚¹${d.totalSales}<br>
          <b>Total Expenses:</b> â‚¹${d.totalExpenses}<br>
          <b>Net Result:</b> â‚¹${d.profit}<br><br>
          <b>AI Prediction:</b><br>${d.prediction}
        `;
            });

        /* ðŸ”¹ LOAD ALL SALES DATA */
        fetch("http://localhost:5000/sales", {
            headers: { Authorization: token }
        })
            .then(r => r.json())
            .then(data => allSales = data);

        function analyzeProduct() {
            const name = productSearch.value.trim().toLowerCase();
            if (!name) {
                alert("Enter product name");
                return;
            }

            const now = new Date();
            const thisMonth = now.getMonth();
            const lastMonth = thisMonth - 1;

            let lastQty = 0;
            let currentQty = 0;

            allSales.forEach(s => {
                if (s.product.toLowerCase() === name) {
                    const d = new Date(s.date);
                    const m = d.getMonth();
                    const q = Number(s.qty || 0);

                    if (m === lastMonth) lastQty += q;
                    if (m === thisMonth) currentQty += q;
                }
            });

            const predictedQty = currentQty + (currentQty - lastQty);

            /* ðŸ”¹ AI DECISION */
            if (predictedQty > currentQty && currentQty > 0) {
                decision.innerText = "âœ… This product is selling well â†’ RESTOCK recommended";
                decision.style.color = "green";
            } else {
                decision.innerText = "âŒ Low demand â†’ NO restock needed";
                decision.style.color = "red";
            }

            /* ðŸ”¹ DRAW GRAPH */
            const ctx = document.getElementById("productChart").getContext("2d");
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Last Month", "Current Month", "Next Month (Predicted)"],
                    datasets: [{
                        label: "Quantity Sold",
                        data: [lastQty, currentQty, predictedQty > 0 ? predictedQty : 0],
                        backgroundColor: ["#FF9800", "#4CAF50", "#2196F3"]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        function downloadPDF() {
            fetch("http://localhost:5000/download-pdf", {
                headers: { Authorization: token }
            })
                .then(res => res.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "business-report.pdf";
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
        }

        function downloadExcel() {
            fetch("http://localhost:5000/download-excel", {
                headers: { Authorization: token }
            })
                .then(res => res.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "business-report.xlsx";
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
        }

        function emailReport() {
            fetch("http://localhost:5000/email-report", {
                headers: { Authorization: token }
            })
                .then(res => res.json())
                .then(d => alert(d.msg));
        }

    </script>

</body>

</html>
